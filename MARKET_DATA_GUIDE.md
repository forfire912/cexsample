# CTP 行情订阅功能使用指南

## 功能概述

本系统已成功集成 CTP 行情 API（MdApi），支持实时行情订阅和推送功能。

## 为什么需要行情 API？

### 问题背景
之前的版本使用 `ReqQryDepthMarketData` 通过交易 API 查询行情，但存在以下问题：
1. **不支持实时推送**：只能查询静态数据
2. **柜台限制**：大部分 CTP 柜台不支持通过交易接口查询行情
3. **返回空数据**：即使查询成功，也可能返回空数据

### 解决方案
使用专用的**行情 API（MdApi）**进行实时行情订阅：
- ✅ 连接到行情前置服务器
- ✅ 订阅指定合约的实时行情
- ✅ 自动接收行情推送（OnRtnDepthMarketData 回调）
- ✅ 显示实时价格、涨跌幅、成交量等信息

## 使用步骤

### 第一步：连接交易服务器
1. 填写**经纪商ID、用户ID、密码、交易前置、认证码**
2. 点击 **"连接登录"** 按钮
3. 等待显示"Login success"

### 第二步：查询合约列表
1. 点击 **"查询合约"** 按钮
2. 等待合约列表加载完成
3. **点击任意合约行**，合约代码会自动填写到输入框

### 第三步：连接行情服务器
1. 确认**行情前置地址**正确（默认：`tcp://106.37.101.162:31213`）
2. 点击 **"连接行情"** 按钮
3. 等待显示"行情登录成功！可以订阅行情了"

### 第四步：订阅实时行情
1. 确保合约代码已填写（或从列表中选择）
2. 点击 **"订阅行情"** 按钮
3. 实时行情数据会自动显示在列表中并持续更新

## 界面说明

### 新增控件
- **合约代码输入框**：输入或自动填写要查询的合约代码
- **行情前置输入框**：行情服务器地址（与交易前置不同）
- **连接行情按钮**：连接到行情服务器
- **订阅行情按钮**：订阅指定合约的实时行情

### 行情数据列
订阅成功后，列表显示以下信息：
- **Instrument**：合约代码
- **LastPrice**：最新价
- **PreClose**：昨收价
- **Open**：开盘价
- **High**：最高价
- **Low**：最低价
- **Volume**：成交量
- **OpenInt**：持仓量
- **Change**：涨跌额
- **Change%**：涨跌幅
- **UpdateTime**：更新时间

## 技术架构

### API 分离
```
api/
├── traderapi/          # 交易 API
│   ├── ThostFtdcTraderApi.h
│   ├── thosttraderapi.dll
│   └── thosttraderapi.lib
└── mdapi/              # 行情 API（新增）
    ├── ThostFtdcMdApi.h
    ├── thostmduserapi.dll
    └── thostmduserapi.lib
```

### 代码结构
- **MdSpi 类**：实现行情 SPI 接口
  - `OnFrontConnected`：行情服务器连接成功
  - `OnRspUserLogin`：行情登录成功
  - `OnRspSubMarketData`：订阅响应
  - `OnRtnDepthMarketData`：实时行情推送（核心功能）

- **导出函数**：
  - `ConnectMarketData`：连接行情服务器
  - `SubscribeMarketData`：订阅合约
  - `UnsubscribeMarketData`：取消订阅
  - `IsMarketDataConnected`：检查连接状态

## 注意事项

### 1. 前置地址
- **交易前置**：用于交易、查询持仓、委托等
- **行情前置**：专门用于行情订阅
- 两者地址通常不同，请向券商确认

### 2. 登录要求
- 行情登录和交易登录是**独立的**
- 需要分别连接和登录
- 使用相同的用户名和密码

### 3. 订阅限制
- 每次只能订阅一个合约（可扩展为多合约）
- 订阅成功后会持续接收推送
- 交易时间内行情才会更新

### 4. 性能优化
- 行情推送频率很高（每秒多次）
- 当前版本每次推送会刷新整个列表
- 建议：避免同时订阅过多合约

## 常见问题

### Q1：点击"订阅行情"后没有数据？
**A1：** 检查以下几点：
1. 是否先点击了"连接行情"并登录成功？
2. 合约代码是否正确？
3. 当前是否是交易时间？
4. 行情前置地址是否正确？

### Q2：提示"请先连接行情服务器"？
**A2：** 需要先点击"连接行情"按钮，等待行情登录成功后才能订阅。

### Q3：如何同时查看多个合约的行情？
**A3：** 当前版本只支持单合约订阅。如需多合约，可以多次订阅（需修改代码支持多行显示）。

### Q4：行情数据不更新？
**A4：** 
- 检查是否在交易时间内
- 检查网络连接
- 尝试取消订阅后重新订阅

## 开发说明

### 如何扩展为多合约订阅？
修改 `OnRtnDepthMarketData` 函数：
```cpp
// 当前：每次清空列表
ClearListView();

// 改为：检查合约是否已存在，更新或新增行
int existingRow = FindInstrumentRow(pDepthMarketData->InstrumentID);
if (existingRow >= 0) {
    UpdateRow(existingRow, pDepthMarketData);
} else {
    AddNewRow(pDepthMarketData);
}
```

### 如何取消订阅？
添加"取消订阅"按钮，调用：
```c
UnsubscribeMarketData(g_pTrader, instrumentID);
```

## 更新日志

**v2.0 - 2026-01-13**
- ✅ 新增 MdApi 行情 API 支持
- ✅ 实现实时行情订阅功能
- ✅ 添加行情服务器连接功能
- ✅ 优化界面布局
- ✅ 支持点击合约自动填写代码
- ✅ 添加定时器检测行情查询结果

**v1.0 - 初始版本**
- 基础交易功能
- 委托、持仓查询
- 合约查询

---

**技术支持**：如有问题，请查看 `ctp_debug.log` 日志文件。
